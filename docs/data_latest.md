数据库说明文档（Real Estate 系统）
1. 用户表：User 
字段名		类型	约束/默认值			描述
id			Int			主键			用户唯一 		ID
username	Char(50)						唯一	用户名
email		Char(100)					唯一	用户邮箱
password	Char(255)	必填			密码（加密存储）
role	Enum	USER / AGENT / ADMIN, 		 默认 USER	用户角色

id            Int            Primary Key            Unique User ID         	ID
username   Char(50)                        		Unique    Username
email       Char(100)                    			Unique    User Email
password   Char(255)   	 Required				Password (stored encrypted)
role    		Enum    		USER / AGENT / ADMIN,       Default USERUser role
关系：

一对多：User → Property (properties) 1 → N Property

一对多：User → UserAction (actions)  1 → N UserAction

一对多：User → UserActionAggregate (action_aggregates) 1 → N UserActionAggregate

2. 房产表：Property
字段名	类型	约束/默认值		描述
id		In			主键		房产唯一 ID
owner	FK → User	必填		房产发布人
title		Char(255)	必填		房产标题
description	Text				可为空			房产描述
buy_price	Decimal(12,2)	可为空			买卖价格
rent_price	Decimal(12,2)	可为空			出租价格
currency	Char(8)				默认 AUD		币种
area	Float					可为空			房产面积
bedrooms_num	Int			可为空			卧室数量
bathrooms_num	Int			可为空			卫生间数量
year_built		Int			可为空			建造年份
category		Char(255)			可为空			房产类别
address		Char(255)			可为空			地址
suburb		Char(255)			可为空			区域
city			Char(100)			可为空			城市
features		JSON				默认空数组		房产特性（数组）
lat			Float				可为空			纬度
lng			Float				可为空			经度
property_type	Enum							SALE / RENT	房产类型
created_at		Datetime		自动生成	创建时间
updated_at		Datetime		自动更新	更新时间


id        In            Primary Key         Property unique ID
owner    FK → User    	Required         Property advertiser
title       Char(255)    		Required         Property title
description  ext            	Allowed null       Property description
buy_price    Decimal(12,2)    Allowed null	   Sale price
rent_price    Decimal(12,2)    Nullable          Rental price
currency    	 Char(8)          Default AUD      Currency
area    Float                    Nullable            Property area
bedrooms_num    Int            Nullable			Number of bedrooms
bathrooms_num    Int            May be null            Number of bathrooms
year_built        Int            May be null            Year built
category        Char(255)            May be null            Property category
address        Char(255)            May be null			Address
suburb        Char(255)            May be null            Suburb
city            Char(100)            May be null            City
features        JSON                Default empty array        Property features (array)
lat            Float                May be null			Latitude
lng            Float                May be null            Longitude
property_type    Enum                            SALE / RENT    Property Type
created_at        Datetime        Autogenerated    Creation Date
updated_at        Datetime        Automatically updated    Last Updated Date
关系：

一对多：Property → PropertyImage (images)

一对多：Property → UserAction (actions)

一对多：Property → UserActionAggregate (action_aggregates)

索引：

(property_type, city, suburb)

(owner, created_at)

用途：
存储系统房产信息，包括买卖和出租的房源。

3. 房产图片表：PropertyImage
字段名	类型	约束/默认值	描述
id	Int	主键	图片 ID
property	FK → Property	必填	对应房产
url	Char(1024)	必填	图片 URL
uploaded_at	Datetime	自动生成	上传时间
Field Name    Type    Constraints/Default    Description
id    Int    Primary Key    Image ID
property    FK → Property    Required    Corresponding property
url    Char(1024)    Required    Image URL
uploaded_at    Datetime    Auto-generated    Upload time
用途：存储房产的图片信息，每个房产可以有多张图片。

4. 用户行为表：UserAction
字段名	类型	约束/默认值	描述
id	Int	主键	行为记录 ID
user	FK → User	必填	行为用户
property	FK → Property	必填	关联房产
action_type	Enum	CLICK / VIEW / FAVORITE / SHARE	行为类型
timestamp	Datetime	自动生成	行为发生时间
metadata	JSON	可为空	额外信息（可选）
Field Name    Type    Constraints/Default    Description
id    Int    Primary Key    Behaviour record ID
user    FK → User    Required    Behaviour user
property    FK → Property    Required    Associated property
action_type    Enum    CLICK / VIEW / FAVOURITE / SHARE    Behaviour type
timestamp    Datetime    Auto-generated    Behaviour occurrence time
metadata    JSON    May be null    Additional information (Optional)
索引：index
(user, property, action_type)

(property, timestamp)

用途：
记录用户对房产的操作事件，用于统计和行为分析。

5. 用户行为聚合表：UserActionAggregate
字段名	类型	约束/默认值	描述
id	Int	主键	聚合记录 ID
user	FK → User	必填	行为用户
property	FK → Property	必填	关联房产
action_type	Enum	CLICK / VIEW / FAVORITE / SHARE	行为类型
count	Int	默认 0	累计次数
updated_at	Datetime	自动更新	更新时间

唯一约束：(user, property, action_type)
Field Name    Type    Constraints/Default    Description
id    Int    Primary Key    Aggregates record ID
user    FK → User    Required    Behavioural user
property    FK → Property    Required    Associated property
action_type    Enum    CLICK / VIEW / FAVOURITE / SHARE    Behaviour type
count    Int    Default 0    Cumulative count
updated_at    Datetime    Auto-updated    Update time



CREATE TABLE IF NOT EXISTS "user" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "username" VARCHAR(50) NOT NULL UNIQUE,
    "email" VARCHAR(100) NOT NULL UNIQUE,
    "password" VARCHAR(255) NOT NULL,
    "role" VARCHAR(20) NOT NULL DEFAULT 'user'
);
 
COMMENT ON COLUMN "user"."role" IS 'USER: user\nAGENT: agent\nADMIN: admin';
CREATE TABLE IF NOT EXISTS "properties" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "title" VARCHAR(255) NOT NULL,
    "description" TEXT,
    "buy_price" DECIMAL(12,2),
    "rent_price" DECIMAL(12,2),
    "currency" VARCHAR(8) NOT NULL DEFAULT 'AUD',
    "area" DOUBLE PRECISION,
    "bedrooms_num" INT,
    "bathrooms_num" INT,
    "year_built" INT,
    "category" VARCHAR(255),
    "address" VARCHAR(255),
    "suburb" VARCHAR(255),
    "city" VARCHAR(100),
    "features" JSONB NOT NULL,
    "lat" DOUBLE PRECISION,
    "lng" DOUBLE PRECISION,
    "property_type" VARCHAR(4) NOT NULL,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "owner_id" INT NOT NULL REFERENCES "user" ("id") ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS "idx_properties_propert_17ce5d" ON "properties" ("property_type", "city", "suburb");
CREATE INDEX IF NOT EXISTS "idx_properties_owner_i_9d5009" ON "properties" ("owner_id", "created_at");
COMMENT ON COLUMN "properties"."property_type" IS 'SALE: sale\nRENT: rent';
CREATE TABLE IF NOT EXISTS "property_images" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "url" VARCHAR(1024) NOT NULL,
    "uploaded_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "property_id" INT NOT NULL REFERENCES "properties" ("id") ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS "idx_property_im_propert_0566ab" ON "property_images" ("property_id");
CREATE TABLE IF NOT EXISTS "user_actions" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "action_type" VARCHAR(50) NOT NULL,
    "timestamp" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "metadata" JSONB,
    "property_id" INT NOT NULL REFERENCES "properties" ("id") ON DELETE CASCADE,
    "user_id" INT NOT NULL REFERENCES "user" ("id") ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS "idx_user_action_user_id_5def17" ON "user_actions" ("user_id", "property_id", "action_type");
CREATE INDEX IF NOT EXISTS "idx_user_action_propert_4e068b" ON "user_actions" ("property_id", "timestamp");
COMMENT ON COLUMN "user_actions"."action_type" IS 'CLICK: click\nFAVORITE: favorite\nVIEW: view\nSHARE: share';
CREATE TABLE IF NOT EXISTS "user_action_aggregates" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "action_type" VARCHAR(50) NOT NULL,
    "count" INT NOT NULL DEFAULT 0,
    "updated_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "property_id" INT NOT NULL REFERENCES "properties" ("id") ON DELETE CASCADE,
    "user_id" INT NOT NULL REFERENCES "user" ("id") ON DELETE CASCADE,
    CONSTRAINT "uid_user_action_user_id_6cfe5e" UNIQUE ("user_id", "property_id", "action_type")
);
CREATE INDEX IF NOT EXISTS "idx_user_action_propert_b91843" ON "user_action_aggregates" ("property_id", "action_type");
COMMENT ON COLUMN "user_action_aggregates"."action_type" IS 'CLICK: click\nFAVORITE: favorite\nVIEW: view\nSHARE: share';
CREATE TABLE IF NOT EXISTS "aerich" (
    "id" SERIAL NOT NULL PRIMARY KEY,
    "version" VARCHAR(255) NOT NULL,
    "app" VARCHAR(100) NOT NULL,
    "content" JSONB NOT NULL
);"""

更新:
User 表新增字段：license_number、phone_number、company
唯一性：对 license_number 建部分唯一索引（仅对 role='agent' 生效）。
必填性：用 CHECK 约束 限制：当 role='agent' 时 license_number、phone_number 不能为空；非 agent 必须为 NULL（避免把经纪人字段误填到普通用户上）。
User table new fields: licence_number, phone_number, company
Uniqueness: Create a partial unique index on licence_number (applies only when role=“agent”).
Mandatory fields: Use CHECK constraints to restrict: When role=“agent”, licence_number and phone_number cannot be null; non-agents must be NULL (to prevent broker fields being mistakenly entered for regular users).
    -- 1) 新增列
    ALTER TABLE "user"
      ADD COLUMN license_number  VARCHAR(20),
      ADD COLUMN phone_number   VARCHAR(20),
      ADD COLUMN company        VARCHAR(100);

    -- 2) 仅对 agent 强制必填；非 agent 必须为 NULL（避免误填）
    ALTER TABLE "user"
      ADD CONSTRAINT chk_user_agent_license
      CHECK (role <> 'agent' OR license_number IS NOT NULL);

    ALTER TABLE "user"
      ADD CONSTRAINT chk_user_agent_phone
      CHECK (role <> 'agent' OR phone_number IS NOT NULL);

    ALTER TABLE "user"
      ADD CONSTRAINT chk_user_nonagent_license_null
      CHECK (role = 'agent' OR license_number IS NULL);

    ALTER TABLE "user"
      ADD CONSTRAINT chk_user_nonagent_phone_null
      CHECK (role = 'agent' OR phone_number IS NULL);

    -- 3) 部分唯一索引：只对 agent 的 license_number 唯一
    CREATE UNIQUE INDEX uq_user_license_agent
      ON "user"(license_number)
      WHERE role = 'agent';

    -- 4) 便于筛选，经常用到可加 role 索引
    CREATE INDEX idx_user_role ON "user"(role);
    """

async def downgrade(db: BaseDBAsyncClient) -> str:
    return """
    -- 回滚顺序：先删索引，再删约束，最后删列
    DROP INDEX IF EXISTS uq_user_license_agent;
    DROP INDEX IF EXISTS idx_user_role;

    ALTER TABLE "user" DROP CONSTRAINT IF EXISTS chk_user_agent_license;
    ALTER TABLE "user" DROP CONSTRAINT IF EXISTS chk_user_agent_phone;
    ALTER TABLE "user" DROP CONSTRAINT IF EXISTS chk_user_nonagent_license_null;
    ALTER TABLE "user" DROP CONSTRAINT IF EXISTS chk_user_nonagent_phone_null;

    ALTER TABLE "user"
      DROP COLUMN IF EXISTS company,
      DROP COLUMN IF EXISTS phone_number,
      DROP COLUMN IF EXISTS license_number;
    """
Property：
PropertyType: BUY / RENT（将原有的SALE改为BUY）
新增：邮政编码、车位、土地面积、距离
成交日期、交易方式（仅用于数据分析）
PropertyType: BUY / RENT (amend existing SALE to BUY)
New additions: Postcode, Parking space, Land area, Distance, 
Transaction date, Transaction method (for data analysis purposes only)
